# 高度な意味的マップ生成に向けた改善提案

## 1. 現状の課題

現在の `md2map` は **ATX見出し (`#`) のみに依存** してセクションを分割しています。
現行実装は `MarkdownParser` が見出し抽出とセクション構築を単一路線で担い、後段の再分割ステップは存在しません。
このため、以下のような場合に「意味的マップ」としての機能が低下します。

- **巨大な冒頭セクション**: 「はじめに」や「概要」の下に数百行のテキストが続き、見出しがない場合、一つの巨大な「分割片」になってしまう。
- **構造化されていない文書**: 箇条書きや表で重要な情報が記述されているが、見出しが適切に使われていない文書。
- **文脈の変化**: 同一セクション内で話題が転換しているが、見出しで区切られていない場合。

---

## 2. 提案：ハイブリッド・セマンティック・マッピング

見出しベースの「骨格」は維持しつつ、その内部をインテリジェントに細分化・構造化するアプローチを提案します。

### アプローチ A: NLP (形態素解析・統計) による「マイクロ・チャンキング」

AIを使わずにローカルで高速に処理する手法です。

1. **境界検知 (Topic Boundary Detection)**:
    - 日本語形態素解析器 (MeCab, Sudachi, Janome) を使用して、名詞の出現頻度やTF-IDFの推移を計算。
    - 文末表現（「〜です。」「〜である。」）と段落の区切りでスコアリングし、話題の転換点（Cohesion Scoreの低下）を推定して分割。
2. **構造化要素の活用**:
    - リスト (`-`, `1.`) やテーブル、引用ブロック (`>`) を「暗黙の見出し」候補として重み付け。
    - 特筆すべき用語 (抽出されたキーワード) が集中している箇所を独立したサブセクションとして扱う。

### アプローチ B: AI (LLM) による「論理構造の動的再構成」

LLMを活用して、より人間に近い感覚で「意味の区切り」を見つける手法です。

1. **自動サブスヘディング生成**:
    - 巨大なセクション（例：500文字以上）をLLMに入力し、「この文章を論理的な3〜5つのサブセクションに分け、適切な見出しを付けてください」と指示。
    - 元のマークダウンを書き換えるのではなく、`MAP.json` や `INDEX.md` 上でのみ「仮想的な見出し（Virtual Headings）」として管理。
2. **意味的要約の強化**:
    - 単なる冒頭抽出ではなく、セクション全体の内容を俯瞰した要約を生成し、`INDEX.md` の検索性を高める。

### アプローチ C: 行統計ベースの適応的分割

もっともシンプルなプログラム的な解決策です。

- **閾値ベースの強制分割**: 500行以上の見出しなしブロックがある場合、段落の区切りで強制的に「（続き）」として分割。
- **視覚的密度解析**: 空行の数やインデントの深さが変化するポイントを境界として学習。

---

## 3. 具体的な実装アイデア (md2map への統合)

### 3.1 階層構造の拡張 (`Section` モデルの更新)

`Section` クラスに `is_virtual` 属性を追加し、明示的な見出しがない「意味的な区切り」を扱えるようにします。

```python
@dataclass
class Section:
    # ... 既存の属性 ...
    is_virtual: bool = False  # 見出し記法ではないが、意味的に分割された場合にTrue
    split_reason: str = ""    # 分割された理由（"AI Splitting", "Paragraph Break" 等）
    virtual_title: str = ""   # 仮想見出し名（is_virtual=True のとき title 表示に使用）
```

### 3.2 パイプラインの変更

`MarkdownParser` に `Refinement` ステップを追加します（現状の見出し抽出後の段階に挿入）。

1. `_extract_headings`: 従来通りのパース。
2. `_refine_large_sections`: 抽出された各セクションをチェック。
    - もし文字数/行数が一定以上なら、`SemanticSplitter` を呼び出し。
3. `SemanticSplitter`:
    - オプションに応じて、Sudachi (NLP) または GPT-4o (AI) で内部をさらに `Section` オブジェクトに再分割。

### 3.3 実装ルール（確定）

確定した実装ルールの詳細は [enhancement_plan.md](enhancement_plan.md) セクション 2.4 を参照。

---

## 4. 期待される効果

- **AI解析の精度向上**: 一度のコンテキストに入力する情報が「意味的に完結した適切なサイズ」に保たれる。
- **ナビゲーションの改善**: `INDEX.md` が「見かけ上の構造」ではなく「内容の推移」を反映したものになる。
- **柔軟な対応**: 記述ルールがルーズな文書でも、本ツールを通すことで「解析しやすい形」に整えられる。

## 5. 次のステップへの問いかけ

どの方向性を優先して検討・プロトタイプ作成すべきでしょうか？

1. **NLP (Sudachi等) による軽量な統計的分割**
2. **LLMを用いた高度な仮想見出し生成**
3. **まずは単純な文字数/段落ベースのルール追加**
