# spec-code-ai-reviewer → spec-code-ai-mapper への変更

`spec-code-ai-reviewer/versions/v0.8.0`（ベース）から `versions/v0.8.0`（修正版）への初回コミット時点での変更点。

## 1. リブランディング（reviewer → mapper）

プロジェクト名を `spec-code-ai-reviewer` から `spec-code-ai-mapper` に変更。全体に渡る名称変更。

| 対象 | 変更内容 |
|------|----------|
| backend/pyproject.toml | パッケージ名・説明文を `spec-code-ai-mapper-backend` に変更 |
| backend/app/main.py | FastAPI タイトル・説明文・バージョン取得先を変更 |
| backend/app/routers/review.py | バージョン取得先を変更 |
| spec.md | タイトル・目的・課題の説明を「AIレビュアー」から「AIマッパー/紐付け管理」に変更 |
| config-file-generator-spec.md | 参照先名を変更 |
| frontend reviewer/index.tsx | APP_INFO の name/description を変更 |

## 2. プリセット機能の削除

`spec-code-ai-reviewer` にあったプロンプトプリセットカタログ機能を全面削除し、シンプルなデフォルト値に置き換え。

### 削除されたファイル（reviewer側のみ）

| ファイル | 説明 |
|------|------|
| core/data/presetCatalog.ts | プリセットカタログデータ |
| core/hooks/usePresetCatalog.ts | プリセットカタログフック |
| core/components/shared/SettingsModal/PromptPresetsSection.tsx | プリセット一覧UIコンポーネント |
| features/presets/index.tsx | プリセットページ |
| pages/PresetsPage.tsx | プリセットページラッパー |

### 変更されたファイル

| ファイル | 変更内容 |
|------|----------|
| core/hooks/useSettings.ts | `PRESET_CATALOG` 参照を削除し、`DEFAULT_SPEC_TYPES`/`DEFAULT_SYSTEM_PROMPTS` をインラインで定義 |
| core/index.ts | `PromptPresetsSection`, `usePresetCatalog` のエクスポートを削除 |
| SettingsModal/SettingsModal.tsx | `promptPresets` セクションとプロパティを削除 |
| SystemPromptEditor.tsx | プリセット選択ドロップダウンを削除（`presets`, `selectedPreset`, `onPresetChange` props 削除） |
| useReviewerSettings.ts | `selectPreset`, `applyPreset`, `systemPromptPresets`, `selectedPreset` を削除。カタログ統合ロジックを簡素化 |

## 3. Mapper 機能の追加（新規）

| ファイル | 説明 |
|------|----------|
| features/mapper/Mapper.tsx (198行) | AI Mapper 画面のメインコンポーネント（新規） |
| pages/MapperPage.tsx (5行) | Mapper ページラッパー（新規） |
| App.tsx | `/presets` ルートを削除、`/mapper` ルートを追加 |
| reviewer/index.tsx | ヘッダーのリンクを「プリセット」→「AI Mapper」に変更（アイコンも `BookOpen` → `Layers`） |

## 4. SharedStateContext の導入（新規）

Reviewer と Mapper 間で状態を共有するための React Context を新設。

| ファイル | 説明 |
|------|----------|
| core/contexts/SharedStateContext.tsx (93行) | 共有ステート Context（新規） |
| main.tsx | `SharedStateProvider` で `App` をラップ |

共有されるステート: `specFiles`, `specMarkdown`, `codeFiles`, `codeWithLineNumbers`, `llmConfig`, `currentPromptValues`, `splitSettings`, `splitPreviewResult`

| 変更されたフック | 変更内容 |
|------|----------|
| useFileConversion.ts | ローカル state を `useSharedState()` から取得するように変更 |
| useSplitSettings.ts | 同上 |
| useReviewerSettings.ts | `llmConfig`, `currentPromptValues` を共有ステートから取得 |

## 5. マッピングポリシー機能の追加

構造マッチング時のマッピング方式（standard / strict / detailed）を選択可能に。

| ファイル | 変更内容 |
|------|----------|
| reviewer/types/index.ts | `SplitSettings` に `mappingPolicy` フィールド追加、`StructureMatchingRequest` にも追加 |
| useSplitSettings.ts | デフォルト設定に `mappingPolicy: 'standard'` 追加 |
| SplitSettingsSection.tsx | マッピング方式のラジオボタンUI追加（標準/厳密/詳細） |
| reviewer/index.tsx | `executeStructureMatching` 呼び出し時に `mappingPolicy` を渡すように追加 |
| backend/app/models/schemas.py | `StructureMatchingRequest` に `mappingPolicy` フィールド追加 |
| backend/app/routers/review.py | `mappingPolicy` に応じてプロンプトの `purpose` を切り替えるロジック追加（strict/detailed/standard） |

## 6. バージョン情報の簡素化

| ファイル | 変更内容 |
|------|----------|
| core/hooks/useVersions.ts | バージョンリストを `v0.8.0` のみに変更（v0.6.0, v0.7.0, v0.8.1 を削除） |

# 仕様の確認と修正必要な点

## 1. レビュー実行フローの削除とマッピング実行のメイン画面統合

### 現状の問題

メイン画面（Reviewer）にAIレビュアー時代の「レビュー実行」ボタン、実行中画面、結果表示画面が残っている。
Mapper ページ（`/mapper`）は別ページとして存在するが、メイン画面からそのままマッピングを実行し、結果を表示できるべき。

### 対応方針

メイン画面のレビュー実行フローを削除し、マッピング実行・結果表示をメイン画面に統合する。

Mapper を別ページではなくメイン画面に統合することで、Reviewer と Mapper 間で状態を共有するために導入した `SharedStateContext` は不要になる。
各 state はメインコンポーネント（または統合後のカスタムフック）内でローカルに管理すればよい。

### 対象ファイル

| ファイル | 現状 | 変更内容 |
|------|------|----------|
| features/reviewer/index.tsx | レビュー実行ボタン（L700-723）、`handleReviewExecute`（L483-510）、`executeSplitReviewFlow`（L245-476）、画面切替（main/executing/result）を含む | レビュー実行フローを削除し、マッピング実行・結果表示に置き換え |
| features/reviewer/hooks/useReviewExecution.ts | 一括レビュー実行ロジック（2回実行）、結果管理 | 不要。マッピング実行ロジックに置き換え |
| features/reviewer/components/ExecutingScreen.tsx | 一括レビュー用の実行中画面（スピナー表示） | 不要、または マッピング実行中表示に置き換え |
| features/reviewer/components/SplitExecutingScreen.tsx | 分割レビュー用の実行中画面（フェーズ進捗表示） | 不要、または マッピング実行中表示に置き換え |
| features/reviewer/components/ReviewResult.tsx | レビュー結果表示（OK/Warning/NG判定、レポート、ZIP出力） | 不要。マッピング結果（トレーサビリティ・マトリクス）表示に置き換え |
| core/hooks/useScreenManager.ts | `main` / `executing` / `result` の画面遷移管理 | マッピングフローに合わせてスクリーン定義を見直し |
| features/mapper/Mapper.tsx | 別ページとしてマッピング結果表示（マトリクス表、Markdownエクスポート） | メイン画面に統合。`/mapper` ルートは廃止 |
| pages/MapperPage.tsx | Mapper ページラッパー | 不要（メイン画面に統合） |
| App.tsx | `/mapper` ルート定義 | `/mapper` ルートを削除 |
| core/contexts/SharedStateContext.tsx | Reviewer と Mapper 間で `specFiles`, `specMarkdown`, `codeFiles`, `codeWithLineNumbers`, `llmConfig`, `currentPromptValues`, `splitSettings`, `splitPreviewResult` を共有する React Context | 不要（メイン画面統合により、ページ間の状態共有が不要になる）。削除し、各 state をローカル管理に戻す |
| main.tsx | `SharedStateProvider` で `App` をラップ | `SharedStateProvider` のラップを削除 |
| features/reviewer/hooks/useFileConversion.ts | `useSharedState()` から `specFiles`, `specMarkdown`, `codeFiles`, `codeWithLineNumbers` を取得 | ローカル state に戻す（元の `useState` に戻す） |
| features/reviewer/hooks/useSplitSettings.ts | `useSharedState()` から `splitSettings`, `splitPreviewResult` を取得 | ローカル state に戻す |
| features/reviewer/hooks/useReviewerSettings.ts | `useSharedState()` から `llmConfig`, `currentPromptValues` を取得 | ローカル state に戻す |

## 2. マッピングポリシーに応じたシステムプロンプトのフロントエンド切替

### 現状の問題

マッピングポリシー（standard / strict / detailed）ごとのシステムプロンプト切替がバックエンド（`review.py`）にハードコードされている。
ユーザーがUI上でシステムプロンプトを確認・編集できず、ポリシー選択がプロンプトにどう影響するか見えない。

### 対応方針

ポリシー選択に応じて、フロントエンド側でシステムプロンプト（特に `purpose` フィールド）を切り替える。
ユーザーは SystemPromptEditor で内容を確認・微調整できるようにする。
バックエンドのハードコードされたポリシー別プロンプト生成ロジックは、フロントエンドから送られた `systemPrompt` をそのまま使うように簡素化する。

### 対象ファイル

| ファイル | 現状 | 変更内容 |
|------|------|----------|
| features/reviewer/components/SplitSettingsSection.tsx | マッピングポリシーのラジオボタンUI（L165-207）。ポリシー値を保存するのみで、プロンプトへの反映なし | ポリシー変更時に `currentPromptValues` を切り替えるコールバックを追加 |
| features/reviewer/hooks/useReviewerSettings.ts | `currentPromptValues` を管理、`updatePromptValue()` で個別フィールド更新 | ポリシー別のデフォルトプロンプトテンプレートを定義し、ポリシー変更時に `purpose` を切り替えるロジックを追加 |
| core/components/shared/SystemPromptEditor.tsx | 現在の `currentValues` を表示・編集するUI | 変更不要（ポリシー切替でプロンプト値が変わればそのまま反映される） |
| backend/app/routers/review.py | `mappingPolicy` に基づいて `purpose` をバックエンドで上書き（L198-231） | フロントエンドから送られた `systemPrompt` をそのまま使うように簡素化 |

## 3. 分割設定UIの簡素化（一括/分割選択の廃止）

### 現状の問題

分割設定セクションに「設計書モード: 一括 / 分割」「プログラムモード: 一括 / 分割」を選ぶラジオボタンが残っている。
AIマッパーでは設計書・コード両方の分割が必須であり、一括モードの選択は不要。

### 対応方針

一括/分割の選択UIを削除し、常に「分割」モードで動作するようにする。
分割の深さ（設計書のH2/H3/H4）の選択は残す。

### 対象ファイル

| ファイル | 現状 | 変更内容 |
|------|------|----------|
| features/reviewer/components/SplitSettingsSection.tsx | 設計書モード（一括/分割）のラジオボタン（L98-128）、プログラムモード（一括/分割）のラジオボタン（L132-163） | 一括/分割の選択UIを削除。常に分割モードであることを前提としたUIに変更 |
| features/reviewer/hooks/useSplitSettings.ts | `settings.documentMode`/`settings.codeMode` が `'batch' | 'split'` で管理。`isSplitEnabled` は「いずれかが split なら true」で判定（L144） | `documentMode`/`codeMode` を常に `'split'` に固定。`isSplitEnabled` は常に `true` |
| features/reviewer/types/index.ts | `SplitMode = 'batch' | 'split'`（L160）、`SplitSettings` に `documentMode`/`codeMode` | `SplitMode` 型と `documentMode`/`codeMode` フィールドを廃止、または常に `'split'` 固定 |
| core/contexts/SharedStateContext.tsx | `splitSettings` の初期値に `documentMode: 'batch'`, `codeMode: 'batch'` | 初期値を `documentMode: 'split'`, `codeMode: 'split'` に変更（型を残す場合） |
| features/reviewer/index.tsx | `isSplitEnabled` で分割/一括の分岐処理（L489、L703、L715、L750） | 常に分割モードで動作するように分岐を削除・簡素化 |

## 4. バージョン番号の変更（v0.8.0 → v0.1.0）

### 現状の問題

バージョン番号がAIレビュアー（spec-code-ai-reviewer）から引き継いだ `v0.8.0` のままになっている。
AIマッパーは別プロダクトであるため、`v0.1.0` から開始すべき。

### 対応方針

全ファイルのバージョン番号を `0.8.0` → `0.1.0` に変更する。
ディレクトリ名（`versions/v0.8.0/`）のリネームも必要。

### 対象ファイル

| ファイル | 現状 | 変更内容 |
|------|------|----------|
| spec.md | `バージョン: 0.8.0`、レスポンス例・テストケース等に `v0.8.0` が多数 | `0.1.0` / `v0.1.0` に変更 |
| config-file-generator-spec.md | `バージョン: 0.8.0`、スキーマ定義の `version: 'v0.8.0'` 等 | `0.1.0` / `v0.1.0` に変更 |
| frontend/package.json | `"version": "0.8.0"` | `"version": "0.1.0"` に変更 |
| backend/pyproject.toml | `version = "0.8.0"` | `version = "0.1.0"` に変更 |
| frontend/src/features/reviewer/index.tsx | `APP_INFO.version: 'v0.8.0'` | `'v0.1.0'` に変更 |
| frontend/src/core/hooks/useVersions.ts | `{ value: 'v0.8.0', label: 'v0.8.0', isLatest: true }` | `v0.1.0` に変更 |
| frontend/src/features/config-file-generator/schema/configSchema.ts | `version: 'v0.8.0'`（2箇所） | `'v0.1.0'` に変更 |
| ディレクトリ | `versions/v0.8.0/` | `versions/v0.1.0/` にリネーム |

## 5. マッピング粒度と「詳細（内容参照）」モードの実装不足

### 現状の問題

#### 5-1. マッピング粒度が大まかなグループ単位になっている

現在の実装では、マッピング結果が `MatchedGroup` という単位で返され、1つのグループに複数の設計書セクション（`docSections[]`）と複数のコードシンボル（`codeSymbols[]`）が含まれる多対多のグループ構造になっている（`features/reviewer/types/index.ts` L260-267）。

バックエンドのプロンプトでも「関連性の高い設計書セクションとコードシンボルをグループにまとめる」という指示になっており（`backend/app/routers/review.py` L229-231）、注意事項にも「設計書の複数セクションと、複数のコード部分が、1つのグループに対応する場合もあります」と明記されている（L264-265）。

設計書1項目ごとに対応する関数を1対1（またはそれに近い粒度）でマッピングする仕組みにはなっていない。結果表示画面（`Mapper.tsx`）でも、グループ単位のテーブル表示のみで、設計書項目ごとの対応関数一覧のような表示はない。

#### 5-2. 「詳細（内容参照）」モードの処理が未実装

UIのマッピング方式選択で「詳細（内容参照）」を選んだ場合、説明文には「セクションの内容も一部参照して精度を高めます（トークン消費量が増えます）」と表示される（`SplitSettingsSection.tsx` L204）。

しかし、バックエンドの実装を確認すると、`detailed` モードではシステムプロンプトの指示文が「構造だけでなく、提供されたMAP情報の概要テキストも参照して、意味的に関連の深いセクションとシンボルを網羅的にグループ化してください」に変わるのみで（`review.py` L210-215）、LLMに送信されるデータ自体は `standard` / `strict` モードと同一（INDEX.md と MAP.json のみ）である。設計書やコードの実際の内容（本文テキストやソースコード）がLLMに渡される処理は実装されていない。

つまり、UIの説明文が示す「内容を参照して精度を高める」動作と、実際の実装に乖離がある。

### 確認事項

1. **マッピング粒度の方針**: 設計書1項目ごとの1対1マッピング（またはそれに近い粒度）を実現するか？
   - **A. システムプロンプトで対応**: マッピングポリシー（特に `strict` や `detailed`）のプロンプト指示を変更して、LLMに細粒度の出力を求める。データ構造は `MatchedGroup` のまま、1グループ1セクションに近い出力をプロンプトで誘導する
   - **B. データ構造・UIの変更で対応**: `MatchedGroup` とは別に、設計書項目ごとの対応関数一覧を表示するビュー（設計書セクション一覧 → 各セクションに紐づく関数のリスト）を結果表示画面に追加する
   - **C. 現状のグループ粒度のまま**: 大まかなグループ分けが主目的であり、1対1マッピングは不要

2. **「詳細（内容参照）」モードの実装方針**: UI説明文と実装を整合させるか？
   - **A. 実際にコンテンツを送信**: `detailed` モード選択時に、設計書の本文テキストやコードのソースコードの一部をLLMへのリクエストに含める処理を追加する（トークン消費増加）
   - **B. 説明文を修正**: 実際の動作に合わせてUI説明文を「MAP情報の構造を詳細に分析して精度を高めます」等に変更し、コンテンツ送信は行わない
   - **C. 機能自体を削除**: `detailed` モードを廃止し、`standard` / `strict` の2択にする

### 対象ファイル

| ファイル | 関連箇所 |
|------|----------|
| features/reviewer/types/index.ts | `MatchedGroup` 型定義（L260-267）— グループ構造の変更が必要な場合 |
| backend/app/routers/review.py | 構造マッチングのプロンプト生成（L200-270）— 粒度指示の変更、`detailed` モードでのコンテンツ送信追加 |
| features/mapper/Mapper.tsx | 結果表示テーブル（L153-188）— 細粒度表示ビューの追加が必要な場合 |
| features/reviewer/components/SplitSettingsSection.tsx | マッピング方式の説明文（L201-204）— `detailed` の説明文修正が必要な場合 |
| features/reviewer/index.tsx | `executeStructureMatching` 呼び出し（L64-69 of Mapper.tsx）— `detailed` モード時にコンテンツデータを追加送信する場合 |
