# v0.8.0 セマンティック分割レビュー機能 実装計画書

[!important]
この計画書は PR#41 で対応完了しました。

**作成日**: 2026-02-04
**対象バージョン**: v0.8.0
**関連Issue**:
- [#37](https://github.com/elvezjp/spec-code-ai-reviewer/issues/37)
- [#39](https://github.com/elvezjp/spec-code-ai-reviewer/issues/39)

## 1. 概要

### 1.1 背景

現在のspec-code-ai-reviewerでは、設計書（Markdown変換後）とコード（行番号付与後）をそのままAIに渡してレビューを実行している。しかし、大規模なファイルの場合、AIの入力トークン上限を超えてレビューを実行できないケースがある。

### 1.2 解決策

md2map / code2map を使用して、ファイルを**意味のある単位**（セクション / クラス・関数）に分割し、逐次レビューを実行する機能を追加する。

| ツール | 対象 | 分割単位 |
|--------|------|----------|
| md2map | Markdown設計書 | 見出し（H1/H2/H3）単位 |
| code2map | ソースコード | クラス/メソッド/関数単位 |

### 1.3 実装方針

- v0.7.0ディレクトリを丸ごとコピーしてv0.8.0として作成
- 既存の一括レビュー機能はそのまま維持（後方互換性）
- 分割レビューはユーザーが明示的に選択する

---

## 2. 機能要件

### 2.1 分割モード

以下の4つのモードをサポートする。

| モード | 設計書 | コード | 説明 |
|--------|--------|--------|------|
| 一括（従来） | 一括 | 一括 | 従来通り全体を一度にレビュー |
| 設計書のみ分割 | 分割 | 一括 | 設計書が長大な場合 |
| コードのみ分割 | 一括 | 分割 | コードが長大な場合 |
| 両方分割 | 分割 | 分割 | 両方が長大な場合 |

### 2.2 分割実行の制御

- ユーザーが**明示的に**分割実行を選択する（自動判定は行わない）
- 分割設定は変換後、レビュー実行前に行う
- トークン数の目安を表示し、分割の必要性を判断できるようにする

### 2.3 レビュー結果

- 各パーツのレビュー結果を統合して1つのレポートとして出力
- 元ファイルの行番号へのマッピングを保持
- 分割レビューの場合、全体サマリーを最後に生成

---

## 3. 画面設計

### 3.1 画面構成（変更箇所）

```
┌─────────────────────────────────────────────────────────────────────┐
│  spec-code-ai-reviewer v0.8.0                          [設定] [?]  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 1. 設計書アップロード                                        │   │
│  │    [ファイル選択] design.xlsx                                │   │
│  │    役割: ◉主設計書 ○参考資料   種別: [詳細設計書 ▼]         │   │
│  │    変換ツール: [excel2md (CSV) ▼]                           │   │
│  │                                          [Markdownに変換]    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 2. 設計書プレビュー                                          │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │ # 詳細設計書                                           │  │   │
│  │  │ ## 1. 概要                                             │  │   │
│  │  │ ...                                                    │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 3. プログラムアップロード                                    │   │
│  │    [ファイル選択] UserService.java                          │   │
│  │                                 [add-line-numbersで変換]     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 4. プログラムプレビュー                                      │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │ 1: public class UserService {                         │  │   │
│  │  │ 2:     private UserRepository repo;                   │  │   │
│  │  │ ...                                                    │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │  ← 【既存を拡張】
│  │ 5. 推定入力トークン数                                        │   │
│  │                                                             │   │
│  │  設計書:     約 45,000 tokens                  ← 【新規】内訳表示
│  │  プログラム: 約 12,000 tokens                  ← 【新規】内訳表示
│  │  ─────────────────────────────────                          │   │
│  │  合計:       約 57,000 tokens   ⚠️ モデル上限に注意          │   │  ← 既存
│  │                                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │  ← 【新規セクション】
│  │ 6. 分割設定                                                  │   │
│  │                                                             │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │ 設計書:     ◉ 一括  ○ 分割                          │   │   │
│  │  │ プログラム: ◉ 一括  ○ 分割                          │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  │                                                             │   │
│  │  ▼ 設計書分割オプション（「分割」選択時に展開）             │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │ 分割深度:  ◉ H2まで（推奨）  ○ H3まで  ○ H4まで    │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  │                                                             │   │
│  │  ▼ プログラム分割オプション（「分割」選択時に展開）         │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │ 対応言語: Python (.py) / Java (.java)                │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  │                                                             │   │
│  │                              [分割プレビュー実行]            │   │
│  │                                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 7. レビュー実行                                              │   │
│  │                                                             │   │
│  │  分割設定が選択されています。                                │   │  ← 分割選択時のみ表示
│  │  レビュー実行前に「分割プレビュー実行」を行ってください。     │   │
│  │                                                             │   │
│  │                              [レビュー実行] (無効)           │   │  ← プレビュー未実行時は無効
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 分割プレビュー結果表示

「分割プレビュー実行」ボタンをクリックすると、分割設定セクション内にプレビュー結果が表示される。

```
┌─────────────────────────────────────────────────────────────────────┐
│  6. 分割設定                                                        │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 設計書:     ○ 一括  ◉ 分割                                  │   │
│  │ プログラム: ○ 一括  ◉ 分割                                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ▼ 設計書分割オプション                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 分割深度:  ◉ H2まで（推奨）  ○ H3まで  ○ H4まで            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ▼ プログラム分割オプション                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 対応言語: Java (.java) - 自動検出                           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│                         [分割プレビュー実行] ✓ 実行済み             │
│                                                                     │
│  ─────────────────────────────────────────────────────────────────  │
│  プレビュー結果                                                     │
│                                                                     │
│  ■ 設計書: 8 パート                                                 │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ # | セクション名        | 行範囲     | 推定トークン          │   │
│  │---|---------------------|------------|---------------------- │   │
│  │ 1 | 概要                | L1-L50     | ~2,000 tokens         │   │
│  │ 2 | 機能要件            | L51-L200   | ~8,000 tokens         │   │
│  │ 3 | 画面設計            | L201-L450  | ~12,000 tokens        │   │
│  │ 4 | API設計             | L451-L600  | ~7,000 tokens         │   │
│  │ 5 | データベース設計    | L601-L750  | ~6,000 tokens         │   │
│  │ 6 | エラー処理          | L751-L850  | ~4,000 tokens         │   │
│  │ 7 | セキュリティ        | L851-L950  | ~4,000 tokens         │   │
│  │ 8 | 付録                | L951-L1050 | ~2,000 tokens         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ■ プログラム: 5 パート                                             │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ # | シンボル名                  | 行範囲     | 推定トークン  │   │
│  │---|-----------------------------|-----------|--------------│   │
│  │ 1 | UserService (class)         | L1-L250   | ~5,000        │   │
│  │ 2 | UserService#createUser      | L45-L80   | ~1,500        │   │
│  │ 3 | UserService#updateUser      | L82-L120  | ~1,600        │   │
│  │ 4 | UserService#deleteUser      | L122-L150 | ~1,200        │   │
│  │ 5 | UserService#findById        | L152-L180 | ~1,200        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ─────────────────────────────────────────────────────────────────  │
│  レビュー実行情報                                                   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 設計書:     分割 (8 パート)                                  │   │
│  │ プログラム: 分割 (5 パート)                                  │   │
│  │                                                             │   │
│  │ レビュー実行回数: 最大 13 回 (構造マッチング 1回 + ペア 12回) │   │
│  │ ※ 関連性の高いパーツのみレビューするため、実際の回数は減少   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  分割プレビュー完了。レビュー実行が可能です。                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 分割レビュー実行中画面

分割レビュー実行中は専用画面（SplitExecutingScreen）を新規作成して進捗を表示する。
既存のExecutingScreenは一括レビュー用としてそのまま維持する。

```
┌─────────────────────────────────────────────────────────────────────┐
│  ← 戻る                                       分割レビュー実行中    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 1. 構造マッチング                                    ✓ 完了 │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  マッチング結果: 3グループ                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 2. グループレビュー                                ⏳ 実行中 │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │                                                             │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │ 2.1 ユーザー管理                             ✓ 完了 │   │   │
│  │  ├─────────────────────────────────────────────────────┤   │   │
│  │  │  設計: ユーザー管理機能、ユーザー登録、ユーザー更新  │   │   │
│  │  │  コード: UserService, UserRepository                │   │   │
│  │  │  サマリー: バリデーション仕様に差異あり（警告2件）   │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  │                                                             │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │ 2.2 認証機能                                ⏳ 実行中 │   │   │
│  │  ├─────────────────────────────────────────────────────┤   │   │
│  │  │  設計: 認証機能、ログイン、トークン管理              │   │   │
│  │  │  コード: AuthService, TokenManager                  │   │   │
│  │  │  🔄 レビュー実行中...                               │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  │                                                             │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │ 2.3 データ管理                               ○ 待機中 │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  │                                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 3. 結果統合                                        ○ 待機中 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│                              [一時停止]                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.3.1 一時停止中の表示

「一時停止」ボタンクリック後の表示。

```
┌─────────────────────────────────────────────────────────────────────┐
│  ← 戻る                                       分割レビュー実行中    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       ⏸️ 一時停止中                          │   │
│  │                                                             │   │
│  │  2. グループレビュー (1/3 グループ完了)                      │   │
│  │                                                             │   │
│  │  完了済みの結果は保持されています。                          │   │
│  │  再開すると 2.2 認証機能 から処理を継続します。              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  （以下、1〜3の表示は同様）                                         │
│                                                                     │
│                               [再開]                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. バックエンド設計

### 4.1 ステートレス設計

**サーバー側に状態を持たない設計を採用。**

#### 4.1.1 設計方針

- 各APIはリクエストで受け取ったデータのみを使用して処理
- 処理結果はレスポンスで直接返却（サーバー側に保存しない）
- セッション管理、進捗管理はフロントエンドが担当
- 途中失敗時の再実行もフロントエンドが制御

#### 4.1.2 一時ファイルの扱い

md2map / code2map CLI呼び出し時のみ一時ファイルを使用。

```python
import tempfile
from contextlib import contextmanager

@contextmanager
def temporary_file_for_cli(content: str, suffix: str):
    """CLI呼び出し用の一時ファイル（API処理完了時に自動削除）"""
    with tempfile.NamedTemporaryFile(mode='w', suffix=suffix, delete=True) as f:
        f.write(content)
        f.flush()
        yield f.name
    # with句を抜けると自動削除
```

- 一時ファイルは単一API呼び出し内でのみ使用
- API処理完了時に即座に削除（finally句で確実に削除）
- セッション間でのファイル共有は行わない

### 4.2 新規APIエンドポイント

| Method | Path | 説明 | 呼び出し回数 |
|--------|------|------|-------------|
| POST | `/api/split/markdown` | Markdownをmd2mapで分割 | 1回 |
| POST | `/api/split/code` | コードをcode2mapで分割 | ファイル数分 |
| POST | `/api/review/structure-matching` | 構造マッチング（グループ特定） | 1回 |
| POST | `/api/review/group` | グループレビュー | グループ数分 |
| POST | `/api/review/integrate` | 結果統合 | 1回 |

#### 4.2.1 API設計方針

**ステートレス設計（フロントエンド状態管理）**

- サーバー側に状態を持たない
- 各APIの結果はフロントエンドで保持
- 途中失敗時の再実行はフロントエンドが制御
- 進捗表示もフロントエンドで管理

```
フロントエンド実行フロー:
1. /api/split/markdown      → 設計書分割結果を保持
2. /api/split/code (×N)     → コード分割結果を保持
3. /api/review/structure-matching → グループ情報を保持
4. /api/review/group (×M)   → 各グループ結果を保持（進捗表示）
5. /api/review/integrate    → 最終レポート取得
```

**API呼び出し単位**

- `/api/split/code`は1ファイルごとに呼び出す
- `/api/review/group`は1グループごとに呼び出す
- 理由: シンプルな実装、エラーハンドリングの容易さ、途中失敗時の再実行が容易

**レスポンス形式: テキスト直接方式**

- 分割結果・レビュー結果をレスポンスに直接含める
- サーバー側でファイル保存し参照URLを返す方式は採用しない

**選定理由:**

1. **実装がシンプル**: ファイル保存・参照管理・クリーンアップが不要
2. **データサイズが許容範囲**: 各APIのレスポンスは数百KB程度で問題なし
3. **ステートレス**: セッション管理の複雑さを回避
4. **再実行が容易**: 途中失敗時、完了済みの結果を保持したまま失敗箇所から再実行可能

### 4.3 データモデル

```python
from pydantic import BaseModel
from typing import List, Optional
from enum import Enum

# =============================================================================
# 共通モデル
# =============================================================================

class DocumentPart(BaseModel):
    """分割された設計書パーツ"""
    title: str
    path: str
    start_line: int
    end_line: int
    content: str
    estimated_tokens: int

class CodePart(BaseModel):
    """分割されたコードパーツ"""
    filename: str
    symbol: str
    type: str  # class, method, function
    start_line: int
    end_line: int
    content: str
    estimated_tokens: int

# =============================================================================
# 構造マッチングAPI
# =============================================================================

class StructureMatchingRequest(BaseModel):
    """構造マッチングリクエスト"""
    document: dict  # { index_md: str, map_json: dict }
    code_files: List[dict]  # [{ filename: str, index_md: str, map_json: dict }]
    llm_config: dict

class MatchedGroup(BaseModel):
    """マッチングされたグループ"""
    group_id: str
    doc_sections: List[dict]  # [{ title: str, path: str }]
    code_symbols: List[dict]  # [{ filename: str, symbol: str }]
    reason: str
    estimated_tokens: int

class StructureMatchingResponse(BaseModel):
    """構造マッチングレスポンス"""
    success: bool
    groups: List[MatchedGroup]
    total_groups: int

# =============================================================================
# グループレビューAPI
# =============================================================================

class GroupReviewRequest(BaseModel):
    """グループレビューリクエスト"""
    group_id: str
    document_parts: List[DocumentPart]
    code_parts: List[CodePart]
    review_options: dict
    llm_config: dict

class ReviewFinding(BaseModel):
    """レビュー指摘事項"""
    id: str
    type: str  # inconsistency, missing_in_code, missing_in_doc, suggestion
    severity: str  # error, warning, info
    doc_location: Optional[dict]  # { section: str, line: int }
    code_location: Optional[dict]  # { filename: str, symbol: str, line: int }
    description: str
    recommendation: str

class GroupReviewResponse(BaseModel):
    """グループレビューレスポンス"""
    success: bool
    group_id: str
    review_result: dict  # { summary: str, findings: List[ReviewFinding], statistics: dict }
    tokens_used: dict  # { input: int, output: int }

# =============================================================================
# 結果統合API
# =============================================================================

class IntegrateRequest(BaseModel):
    """結果統合リクエスト"""
    structure_matching: dict  # 構造マッチング結果
    group_reviews: List[dict]  # 各グループのレビュー結果
    integration_options: dict  # { deduplicate_findings: bool, check_cross_group_issues: bool }
    system_prompt: str  # システムプロンプト設定（注意事項・出力フォーマット情報を含む）
    llm_config: dict

class IntegrateResponse(BaseModel):
    """結果統合レスポンス"""
    success: bool
    report: str  # AIが生成した統合レビューレポート（Markdown形式）
    integrated_report: dict  # { overall_summary, key_issues, cross_group_issues, statistics }
    tokens_used: dict
```

---

## 5. 分割レビューフロー

### 5.1 設計書のみ分割の場合

```
設計書パーツ1 + コード全体 → レビュー結果1
設計書パーツ2 + コード全体 → レビュー結果2
設計書パーツ3 + コード全体 → レビュー結果3
...
全レビュー結果 → 統合サマリー生成 → 最終レポート
```

### 5.2 コードのみ分割の場合

```
設計書全体 + コードパーツ1 → レビュー結果1
設計書全体 + コードパーツ2 → レビュー結果2
設計書全体 + コードパーツ3 → レビュー結果3
...
全レビュー結果 → 統合サマリー生成 → 最終レポート
```

### 5.3 両方分割の場合（重要）

設計書とコードの両方が分割されている場合、全組み合わせをレビューするとN×Mの計算量になる。これを効率化するため、以下の戦略を採用する。

#### 5.3.1 2段階レビュー戦略

```
【フェーズ1: 構造マッチング】
設計書(INDEX.md + MAP.json) + コード(INDEX.md + MAP.json) → AIに関連性を推定させる

※ INDEX.mdは構造の概要、MAP.jsonは詳細なメタデータ（行範囲、シンボル情報等）を含む

AIプロンプト例:
"以下の設計書構造とコード構造を比較し、
 関連性の高いグループを特定してください。
 設計書の複数セクションと、複数のコード部分が対応する場合もあります。"

出力例:
{
  "groups": [
    {
      "id": "group1",
      "doc_sections": ["2. ユーザー管理機能", "2.1 ユーザー登録", "2.2 ユーザー更新"],
      "code_symbols": ["UserService", "UserRepository", "UserValidator"],
      "reason": "ユーザー管理に関連する設計とコード"
    },
    {
      "id": "group2",
      "doc_sections": ["3. 認証機能", "3.1 ログイン", "3.2 トークン管理"],
      "code_symbols": ["AuthService", "TokenManager", "SessionStore"],
      "reason": "認証・セッション管理に関連する設計とコード"
    },
    ...
  ]
}
```

```
【フェーズ2: グループレビュー】
関連性の高いグループ単位でレビュー（多対多の対応）

グループ1: 設計書「2. ユーザー管理機能」「2.1 ユーザー登録」「2.2 ユーザー更新」
         + コード「UserService」「UserRepository」「UserValidator」
    → レビュー結果1

グループ2: 設計書「3. 認証機能」「3.1 ログイン」「3.2 トークン管理」
         + コード「AuthService」「TokenManager」「SessionStore」
    → レビュー結果2

...
```

```
【フェーズ3: 統合】
全レビュー結果 + 構造マッチング結果 + システムプロンプト設定
    → AIが統合してMarkdownレポートを生成
    → 最終レポート（システムプロンプトの注意事項・出力フォーマットに準拠）
```

#### 5.3.2 フロー図

**重要**: code2mapはAST解析を行うため、行番号付与前の元ファイルを入力とする。
また、code2mapは1ファイルごとの実行となるため、複数ファイルがある場合は各ファイルに対して実行する。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           入力ファイル                                   │
│   設計書: design.xlsx                                                   │
│   コード: UserService.java, AuthService.java, Utils.java               │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
        ┌───────────────────────┴───────────────────────┐
        ▼                                               ▼
┌───────────────────┐                         ┌───────────────────────────┐
│ 設計書処理         │                         │ コード処理                 │
│                   │                         │                           │
│ Excel → MD変換    │                         │  ┌───────────────────┐   │
│ (MarkItDown等)    │                         │  │ 元ファイル保持     │   │
│       │          │                         │  │ (フロントエンド)   │   │
│       ▼          │                         │  └─────────┬─────────┘   │
│ 変換後Markdown   │                         │            │             │
│       │          │                         │    ┌───────┴───────┐     │
│       ▼          │                         │    ▼               ▼     │
│ ┌─────────────┐  │                         │ ┌───────────┐ ┌───────┐ │
│ │ md2map分割  │  │                         │ │行番号付与  │ │code2map│ │
│ │(1ファイル)  │  │                         │ │(一括用)   │ │ 分割   │ │
│ └──────┬──────┘  │                         │ └─────┬─────┘ └───┬───┘ │
│        │         │                         │       │   ※元ファイル使用│
│        ▼         │                         │       ▼           │     │
│  - INDEX.md     │                         │ 行番号付き      ファイルごとに
│  - parts/       │                         │ コード(結合)    code2map実行
│  - MAP.json     │                         │ (一括レビュー用)      │     │
└────────┬─────────┘                         └───────┬───────────────┼─────┘
         │                                           │               │
         │  ┌─────────────────────────────────────────┘               │
         │  │                                                        │
         │  │  一括レビュー時                                         │
         │  │  ─────────────                                         │
         │  └──→ 設計書MD + 行番号付きコード → AIレビュー             │
         │                                                           │
         │       分割レビュー時                                       │
         │       ─────────────                                       │
         │                                                           ▼
         │                                    ┌─────────────────────────────┐
         │                                    │ code2map結果（ファイルごと）  │
         │                                    │                             │
         │                                    │ UserService.java:           │
         │                                    │   - INDEX.md, parts/, MAP.json
         │                                    │ AuthService.java:           │
         │                                    │   - INDEX.md, parts/, MAP.json
         │                                    │ Utils.java:                 │
         │                                    │   - INDEX.md, parts/, MAP.json
         │                                    └──────────────┬──────────────┘
         │                                                   │
         └───────────────────────┬───────────────────────────┘
                                 │
                                 ▼
                  ┌────────────────────────────────┐
                  │ フェーズ1: 構造マッチング        │
                  │                                │
                  │ 設計書(INDEX.md + MAP.json) +  │
                  │ 全コードファイルの               │
                  │ (INDEX.md + MAP.json)          │
                  │       ↓                        │
                  │ AIに関連性を推定させる          │
                  │ （多対多のグループを特定）       │
                  └───────────────┬────────────────┘
                                  │
                                  ▼
                  ┌────────────────────────────────┐
                  │ フェーズ2: グループレビュー      │
                  │ （多対多の対応でレビュー）       │
                  │                                │
                  │  ┌────────────────────────┐    │
                  │  │グループ1:              │    │
                  │  │ 設計: ユーザー管理機能  │    │
                  │  │       ユーザー登録     │    │
                  │  │       ユーザー更新     │────┼──→ レビュー1
                  │  │ コード: UserService    │    │
                  │  │        UserRepository │    │
                  │  │        UserValidator  │    │
                  │  └────────────────────────┘    │
                  │  ┌────────────────────────┐    │
                  │  │グループ2:              │    │
                  │  │ 設計: 認証機能         │    │
                  │  │       ログイン        │────┼──→ レビュー2
                  │  │ コード: AuthService    │    │
                  │  │        TokenManager   │    │
                  │  └────────────────────────┘    │
                  │  ...                          │
                  └───────────────┬────────────────┘
                                │
                                ▼
                  ┌──────────────────────────────────┐
                  │ フェーズ3: 統合                   │
                  │ - 全結果を結合                    │
                  │ - 行番号マッピング適用            │
                  │ - システムプロンプト設定を参照    │
                  │ - AIがMarkdownレポートを生成      │
                  └─────────────┬──────────────────┘
                                │
                                ▼
                  ┌──────────────────────────┐
                  │ 最終レビューレポート       │
              └──────────────────────────┘
```

### 5.4 AIへの入力形式

#### 5.4.1 フェーズ1: 構造マッチング用プロンプト

```markdown
# 構造マッチング依頼

以下の設計書構造とコード構造を比較し、関連性の高いグループを特定してください。
設計書の複数セクションと、複数のコード部分が対応する場合もあります。

## 設計書構造

### INDEX.md
{設計書のINDEX.md内容}

### MAP.json
{設計書のMAP.json内容}

## コード構造

### {ファイル名1} - INDEX.md
{コードファイル1のINDEX.md内容}

### {ファイル名1} - MAP.json
{コードファイル1のMAP.json内容}

（複数ファイルがある場合は繰り返し）

## 出力形式

以下のJSON形式で出力してください:

```json
{
  "groups": [
    {
      "id": "group1",
      "doc_sections": ["セクション名1", "セクション名2"],
      "code_symbols": ["ClassName", "ClassName#methodName"],
      "reason": "グループ化の理由"
    }
  ]
}
```
```

#### 5.4.2 フェーズ2: グループレビュー用プロンプト

```markdown
# レビュー依頼

以下の設計書セクションとコードの整合性をレビューしてください。

## レビュー対象グループ

- グループID: {group_id}
- 設計書セクション: {セクション名リスト}
- 対応コード: {シンボル名リスト}

## 設計書内容

### {セクション名1}
{設計書パーツ1の内容}

### {セクション名2}
{設計書パーツ2の内容}

（複数セクションがある場合は繰り返し）

## コード内容

### {ファイル名}:{シンボル名1}
{コードパーツ1の内容}

### {ファイル名}:{シンボル名2}
{コードパーツ2の内容}

（複数シンボルがある場合は繰り返し）

## レビュー観点

1. 設計書の記述とコード実装の整合性
2. 設計書に記載があるがコードに実装されていない機能
3. コードに実装があるが設計書に記載がない機能
4. 命名の一貫性
5. その他の懸念事項

## 出力形式

以下のJSON形式で出力してください:

```json
{
  "summary": "全体的な整合性の評価",
  "findings": [
    {
      "id": "F001",
      "type": "inconsistency|missing_in_code|missing_in_doc|suggestion",
      "severity": "error|warning|info",
      "doc_location": { "section": "セクション名", "line": 25 },
      "code_location": { "filename": "ファイル名", "symbol": "シンボル名", "line": 45 },
      "description": "指摘内容",
      "recommendation": "推奨対応"
    }
  ]
}
```
```

#### 5.4.3 フェーズ3: 統合用プロンプト

統合APIでは、システムプロンプト設定を参照し、その注意事項・出力フォーマットに従ってMarkdownレポートを生成する。

```markdown
# レビュー結果統合依頼

以下のグループレビュー結果を統合し、最終レポートを生成してください。

## システムプロンプト設定

以下の注意事項・出力フォーマットに従ってレポートを作成してください:

{システムプロンプト設定の内容}

## 構造マッチング結果

{構造マッチング結果のJSON}

## グループレビュー結果

### グループ1: {グループ名}
{グループ1のレビュー結果}

### グループ2: {グループ名}
{グループ2のレビュー結果}

（複数グループがある場合は繰り返し）

## 統合指示

1. 各グループのレビュー結果を統合し、重複する指摘を排除してください
2. グループ間にまたがる問題があれば特定してください
3. 全体的な整合性評価を記述してください
4. システムプロンプト設定に記載された出力フォーマットに従って最終レポートを生成してください

## 出力

Markdown形式のレビューレポートを出力してください。
システムプロンプト設定の出力フォーマットに従ってください。
```

---

## 6. 実装タスク

バックエンドの処理が複雑なため、以下の順序で段階的に実装を進める。

### 6.1 Phase 1: 準備

- [×] v0.7.0 → v0.8.0 ディレクトリコピー
- [×] pyproject.toml バージョン更新
- [×] package.json バージョン更新
- [×] md2map / code2map のPythonパス設定

### 6.2 Phase 2: API定義 + フロントエンド実装（バックエンドはスタブ）

**目的**: UIを先に完成させ、API仕様を確定する。バックエンドはダミー応答を返すスタブ実装とする。

#### 6.2.1 バックエンド（スタブ実装）

リクエスト/レスポンスの形式は実際の仕様に合わせる。処理はダミーデータを返す。

- [×] `/api/split/markdown` エンドポイント（スタブ）
  - リクエスト: Markdownテキスト、分割深度
  - レスポンス: ダミーの分割結果（INDEX.md, parts情報, MAP.json形式）
- [×] `/api/split/code` エンドポイント（スタブ）
  - リクエスト: 元ファイル内容、ファイル名
  - レスポンス: ダミーの分割結果（INDEX.md, parts情報, MAP.json形式）
- [×] `/api/review/structure-matching` エンドポイント（スタブ）
  - リクエスト: 設計書・コードのINDEX.md + MAP.json、LLM設定
  - レスポンス: ダミーのグループ情報
- [×] `/api/review/group` エンドポイント（スタブ）
  - リクエスト: グループID、設計書パーツ、コードパーツ、LLM設定
  - レスポンス: ダミーのレビュー結果
- [×] `/api/review/integrate` エンドポイント（スタブ）
  - リクエスト: 構造マッチング結果、全グループレビュー結果、システムプロンプト設定、LLM設定
  - レスポンス: ダミーの統合レポート（AIが生成したMarkdownレポートを含む）

#### 6.2.2 フロントエンド実装

- [×] 「5. 推定入力トークン数」セクションの拡張（TokenEstimator既存）
  - [×] 設計書・プログラム別の内訳表示を追加
- [×] 「6. 分割設定」セクションの追加
  - [×] 設計書/プログラムの一括・分割ラジオボタン
  - [×] 設計書分割オプション（分割深度選択、「分割」選択時に展開）
  - [×] プログラム分割オプション（言語表示、「分割」選択時に展開）
  - [×] 分割プレビュー実行ボタン（設計書・プログラム共通）
  - [×] プレビュー結果表示（設計書・プログラム両方を1画面で表示）
- [×] 「7. レビュー実行」セクションの更新
  - [×] 現在のモード表示
  - [×] 分割時のパート数・実行回数表示
- [×] 分割レビュー進捗表示（SplitExecutingScreen新規作成）
- [×] API呼び出しサービスの実装

### 6.3 Phase 3: バックエンド本実装

スタブ実装を実際のロジックに置き換える。

#### 6.3.1 基盤実装

- [×] トークン数推定ユーティリティ

※ サーバー側はステートレス設計のため、SessionFileManagerや進捗管理は不要

#### 6.3.2 分割処理実装

- [×] `/api/split/markdown` 本実装
  - [×] md2map CLI呼び出し
  - [×] 結果のパース・レスポンス変換
- [ × `/api/split/code` 本実装
  - [×] code2map CLI呼び出し（ファイルごと）
  - [×] 結果のパース・レスポンス変換

#### 6.3.3 レビュー処理実装

- [×] `/api/review/structure-matching` 本実装
  - [×] 構造マッチング用プロンプト生成
  - [×] LLM呼び出し・結果パース
- [×] `/api/review/group` 本実装
  - [×] グループレビュー用プロンプト生成
  - [×] LLM呼び出し・結果パース
- [×] `/api/review/integrate` 本実装
  - [×] 統合用プロンプト生成（システムプロンプト設定を組み込み）
  - [×] LLM呼び出し・Markdownレポート生成
  - [×] 重複指摘の検出・マージ

### 6.4 Phase 4: テスト

- [×] `/api/split/markdown` のユニットテスト
- [×] `/api/split/code` のユニットテスト
- [×] `/api/review/structure-matching` のユニットテスト
- [×] `/api/review/group` のユニットテスト
- [×] `/api/review/integrate` のユニットテスト

### 6.5 Phase 5: ドキュメント

- [×] spec.md 更新
- [×] README更新
- [×] CHANGELOG更新

---

## 7. 設定ファイル変更

### 7.1 ecosystem.config.js

```javascript
const VERSIONS = [
  { name: 'spec-code-ai-reviewer-v0.8.0', cwd: 'versions/v0.8.0', port: 8080 },  // 追加
  { name: 'spec-code-ai-reviewer-v0.7.0', cwd: 'versions/v0.7.0', port: 8070 },
  // ...
];
```

### 7.2 nginx/version-map.conf

```nginx
map $cookie_app_version $backend_port {
    "v0.8.0"  8080;  # 追加
    "v0.7.0"  8070;
    # ...
    default   8080;  # 最新版に更新
}
```

---

## 8. 今後の検討事項

### 8.1 パフォーマンス最適化

- 並列レビュー実行の可否（APIレート制限との兼ね合い）
- キャッシュ戦略（同一ファイルの再分割回避）

### 8.2 UX改善

- 分割の自動推奨（トークン数超過時の警告）
- レビュー結果のリアルタイムストリーミング

### 8.3 セキュリティ

- 一時ファイルの暗号化
- セッションタイムアウト設定
- 同時セッション数制限

---

## 9. 参考資料

- [md2map リポジトリ](https://github.com/elvezjp/md2map)
- [code2map リポジトリ](https://github.com/elvezjp/code2map)
- [Issue #37: 大規模ファイルのレビュー対応](https://github.com/elvezjp/spec-code-ai-reviewer/issues/37)
